<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>OpenLayers Zoomify Example</title>
    <script src="http://oldmapsonline.googlecode.com/svn/trunk/openlayers/OpenLayers.js"></script>
    <script type="text/javascript">

		// OBJ=Max-Size
        var zoomify_width = 9033;
		var zoomify_height = 6967;
		var zoomify_url = "http://www.hdue.it/fastcgiNas/iipsrv.fcgi?FIF=/mnt/nas/Immagini_piramidali/VValerio/Piemonte_Foglio_21.tif";

        var map, zoomify;

        function init(){
	       /* First we initialize the zoomify pyramid (to get number of tiers) */
	        var zoomify = new OpenLayers.Layer.Zoomify( "Zoomify", zoomify_url, 
		  		new OpenLayers.Size( zoomify_width, zoomify_height ) );

	       /* Map with raster coordinates (pixels) from Zoomify image */
	        var options = {
	            controls: [],
	            maxExtent: new OpenLayers.Bounds(0, 0, zoomify_width, zoomify_height),
	            maxResolution: Math.pow(2, zoomify.numberOfTiers-1 ),
	            numZoomLevels: zoomify.numberOfTiers,
	            units: 'pixels'
	        };
			zoomify.getURL = getURLcustom;

	        map = new OpenLayers.Map("map", options);
	        map.addLayer(zoomify);

	        map.addControl(new OpenLayers.Control.MousePosition());
	        map.addControl(new OpenLayers.Control.PanZoomBar());
	        map.addControl(new OpenLayers.Control.MouseDefaults());
	        map.addControl(new OpenLayers.Control.KeyboardDefaults());

            map.setBaseLayer(zoomify);
	        map.zoomToMaxExtent();
        };


	    function getURLcustom (bounds) {
	        bounds = this.adjustBounds(bounds);
	        var res = this.map.getResolution();
			var size = this.getImageSize(bounds);
	        var x = Math.round((bounds.left - this.tileOrigin.lon) / (res * this.tileSize.w));
	        var y = Math.round((this.tileOrigin.lat - bounds.top) / (res * this.tileSize.h));
            var z = this.map.getZoom();
			var tileIndex = x + y * this.tierSizeInTiles[z].w;
			//return "http://chart.apis.google.com/chart?chst=d_text_outline&chs="+size.w+"x"+size.h+"&chf=bg,s,00000055&chld=FFFFFF|16|h|000000|b|"+x+" "+y+"|"+z+"||("+bounds.left+"-"+bounds.right+")|("+bounds.top+"-"+bounds.bottom+")|||||____________________________";
			return "http://www.hdue.it/fastcgiNas/iipsrv.fcgi?FIF=/mnt/nas/Immagini_piramidali/VValerio/Piemonte_Foglio_21.tif&jtl="+z+","+tileIndex;
	        var url = this.url;
	        if (url instanceof Array) {
	            url = this.selectUrl(path, url);
	        }
	        return url + path;
	    };	
    </script>
  </head>
  <body onload="init()">
    <h2 id="title">IIPImage: Maps and Images</h2>
	<a href="http://www.hdue.it/eMaps/opera.htm?idOpera=323">Original Presentation</a>
    <div id="map" style="width:100%; height: 80%; border: 1px solid #aaa;"></div>
  </body>
</html>
